var baseApiUrl=$("#url").val();$(function(){function e(){f===!0?($("#jsGrid").jsGrid("loadData"),o()):clearTimeout(i)}function o(){clearTimeout(i);i=setTimeout(e,3e3)}var r=[{Name:"Ready",Id:1},{Name:"Moved For processing",Id:2},{Name:"Processing",Id:3},{Name:"Completed",Id:4},{Name:"FailedRetry",Id:5},{Name:"Failed",Id:6},{Name:"Paused",Id:7}],n,t,u,i,f;$("#jsGrid").jsGrid({width:"100%",height:"600px",inserting:!1,editing:!0,sorting:!0,paging:!0,autoload:!0,onDataLoaded:function(n){n!==null&&n.data!==null&&updateStats()},rowClass:function(n){var t=String(r[n.status-1].Name);return t.replace(/\s/g,"")},controller:{loadData:function(){return $.ajax({url:baseApiUrl+"/job",dataType:"json"})},deleteItem:function(n){var t=n;return $.ajax({url:baseApiUrl+"/job/"+n.jobId,dataType:"text",method:"DELETE",success:function(n){n===200&&$("#jsGrid").jsGrid("deleteItem",t)},error:function(){alert("Delete failed, Either job is moved to in progress or job is aunavailable")}})}},rowClick:function(n){t("Edit",n.item)},fields:[{name:"jobId",title:"Job Id",type:"text",width:50,validate:"required"},{name:"jobType",title:"Job Type",type:"select",items:[{Name:"ILR",Id:1},{Name:"Reference data",Id:2}],valueField:"Id",textField:"Name",width:110,validate:"required"},{name:"status",title:"Status",type:"select",width:150,items:r,valueField:"Id",textField:"Name"},{name:"dateTimeSubmittedUtc",title:"Submitted Date time",type:"text",width:160},{name:"priority",type:"select",title:"Priority",width:50,items:[{Name:"1",Id:1},{Name:"2",Id:2},{Name:"3",Id:3},{Name:"4",Id:4},{Name:"5",Id:5}],valueField:"Id",textField:"Name"},{name:"dateTimeUpdatedUtc",title:"Updated Date time",type:"text",width:160},{name:"ukprn",type:"number",title:"Ukprn",width:80},{name:"fileName",type:"text",title:"File Name",width:100},{name:"rowVersion",type:"text",title:"",width:0,visible:!1},{type:"control",modeSwitchButton:!1,editButton:!0,headerTemplate:function(){return $("<button>").attr("type","button").text("Add").on("click",function(){t("Add",{})})},itemTemplate:function(n,t){var i=$([]);return t.status===1&&(i=i.add(this._createDeleteButton(t))),i}}]});n=$.noop;$("#detailsDialog").dialog({autoOpen:!1,width:400,close:function(){$("#detailsForm").validate().resetForm();$("#detailsForm").find(".error").removeClass("error")}});$("#detailsForm").validate({rules:{status:"required",priority:{required:!0,range:[1,5]}},messages:{status:"Please enter valid status",priority:"Please enter valid priority"},submitHandler:function(){n()}});t=function(t,i){$("#status").val(i.status);$("#priority").val(i.priority);$("#ukprn").val(i.ukprn);$("#jobType").val(i.jobType);$("#fileName").val(i.fileName);$("#jobId").val(i.jobId);$("#rowVersion").val(i.rowVersion);$("#ukprn").prop("disabled",!1);$("#jobType").prop("disabled",!1);$("#fileName").prop("disabled",!1);$("#status").prop("disabled",!1);$("#priority").prop("disabled",!1);i.jobId>0&&($("#ukprn").prop("disabled",!0),$("#jobType").prop("disabled",!0),$("#fileName").prop("disabled",!0),i.status!==1&&$("#priority").prop("disabled",!0));n=function(){u(i,t==="Add")};$("#detailsDialog").dialog("option","title",t+" Job - Job Id : "+i.jobId).dialog("open")};u=function(n,t){$.extend(n,{priority:parseInt($("#priority").val()),status:parseInt($("#status").val()),jobId:parseInt($("#jobId").val()),ukprn:parseInt($("#ukprn").val()),fileName:$("#fileName").val(),jobType:parseInt($("#jobType").val()),rowVersion:$("#rowVersion").val()});n.jobId=isNaN(n.jobId)?0:n.jobId;$.ajax({url:baseApiUrl+"/job",dataType:"json",method:"POST",contentType:"application/json",data:JSON.stringify(n)}).complete(function(i){i.status===200?(n.jobId=t?i.responseJSON:n.jobId,$("#jsGrid").jsGrid(t?"insertItem":"updateItem",n),$("#detailsDialog").dialog("close"),updateStats()):confirm("Update failed, Job status has been changed. Do you want to refresh the data?")&&($("#detailsDialog").dialog("close"),$("#jsGrid").jsGrid("loadData"))})};$("#autoRefresh").click(function(){f=this.checked;e()});$("#pauseQueue").click(function(){$.ajax({url:baseApiUrl+"/jobManager",headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",dataType:"json",data:this.value==="Pause Queue Processing"?"0":"1"}).complete(function(n){n.status===200?$("#pauseQueue").prop("value",$("#pauseQueue").prop("value")==="Start Queue Processing"?"Pause Queue Processing":"Start Queue Processing"):alert("Queue status changed failed, please try later.")})})});